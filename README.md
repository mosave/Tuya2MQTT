# MQTT Firmware for Tuya WiFi Curtain Motor
### MQTT прошивка для привода раздвижных штор Tuya WiFi

   Приводы для раздвижных штор Tuya Wifi при цене в разы ниже того же Somfy имеют полный набор необходимых функций:
   * Не очень шумные при работе
   * Имеют встроенный энкодер, позволяющий позиционировать шторы с точностью до сантиметра
   * Имеют защиту от перегрузки
   * Автокалибруются при первом открытии/закрытии после включения питания
   * Могут управляться RF433 пультами или просто рукой (достаточно дернуть штору в нужном направлении)
   * Без чрезмерных усилий интегрируются в системы управления "умным домом"
   
    Однако, как и в большинстве подобных IoT устройств, взаимодействие с приводом происходит через внешние сервера. 
А это (опуская страхи перед "большим китайским братом") делает их работу зависимой от наличия и стабильности 
доступа в интернет.

    Целью данного проекта была разработка прошивки WiFi контроллера привода штор для прямого управления через MQTT сервер.
    Следует отметить что это не первая реализация подобной прошивки. Вы можете воспользоваться, например,
    * [Версией прошивки на базе Tasmota](https://github.com/Greefon/docs/blob/master/Tuya-generic-wifi-curtain-motor-WIP.md)
    * Либо [прошивкой на базе ESPHome](https://github.com/iphong/esphome-tuya-curtain)
    Однако в моем случае ни одна из этих прошивок сходу не заработала, поскольку (как выяснилось позже) часть из присланных 
мне приводов имела коды команд управления, не совпадающие с рекомендуемыми в tasmota/esphome мануалах. Кроме того,
большинство устройств у меня построены на [ESP8266 IoT Framework](https://github.com/mosave/AELib), так что 
некоторе время было потрачено на разработку своего варианта прошивки.

    Как и на всех подобных IoT устройствах Tuya модуль управления мотора штор имеет два контроллера:
    * Непосредственно железом (двигатель, энкодеры, контроль перегрузки, калибровка крайних положений, ручное открытие/закрытие штор) 
      управляет низкоуровневый MCU. Он же принимает команды от опционального RF433 пульта управления
    * Внешнее управления шторами через телефон реализуется с помощью модуля [Tuya TYWE3S](https://tasmota.github.io/docs/devices/TYWE3S/), 
      который по факту является обычным ESP8266ex модулем с объемом флеш памяти 2мб, взаимодействующим 
      с MCU через UART интерфейс по стандартизованному Tuya протоколу. При этом модуль 
      не реализует логики управления конкретным устройством а является прозрачным шлюзом, через 
      который с MCU взаимодействует сервер Tuya и/или непосредственно мобильное приложение. 
      Описание протокола можно найти в папке Docs и на сайте того же 
      
    Благодаря такой двухуровневой архитектуре устройство выполняет базовые функции вне зависимости 
от подключения к Internet и работает даже при отказе WiFi модуля. А следовательно можно без особых 
сложностей заменить стандартную прошивку TYWE3S на свою, которая позволит взаимодействовать с приводом штор
напрямую либо через локально установленный MQTT брокер, делая устройство независимым от внешних серверов.

### Прошивка WiFi контроллера

В каталоге [BOT313Firmware](https://github.com/mosave/Beok2MQTT/tree/main/BOT313Firmware) находятся исходники вполне рабочей прошивки, которая тем не менее все еще находится в разработке. В основе прошивки лежит [IoT Framework](https://github.com/mosave/AELib) и поэтому (соответственно) поддерживает все основные команды управления устройством, реализованные в фреймворке.

### Список MQTT топиков и соответствующих им команд для взаимодействия с термостатом

 * **Power**: Состояние термостата. 1 - включен, 0 - выключен
   * **SetPower**: Включить (1) или выключить (0)
 * **RoomTemp**: Текущая температура воздуха (точность 0.5°)
 * **FloorTemp**: Текущая температура внешнего датчика, если поддерживается и установлен
 * **FloorTempMax**: Максимальная температура разаргрева пола (при наличии датчика температуры пола)
   * **SetFloorTempMax**: Установка максимальной температуры разогрева пола
 * **TargetTemp**: Текущая целевая температура
   * **SetTargetTemp**: Установка целевой температуры
 * **TargetTempMax**..**TargetTempMin**: Диапазон допустимых значений целевой температуры

 * **AutoMode**: Включен автоматический (1) либо ручной (0) режим управления
   * **SetAutoMode**: Выбор автоматического (1) либо ручного (0) режима управления

 * **Sensor**: Конфигурация датчиков температуры (зависит от модели термостата, см. документацию)
   * **SetSensor**: Выбор конфигурации датчиков температуры

 * **Heating**: Состояние реле управления обогревателем. 1 - обогреватель включен, 0 - выключен
 * **Locked**: Блокировка кнопок: 1 - включена, 0 - выключена
   * **SetLocked**: Включить (1) или выключить (0) блокировку кнопок
 * **TargetSetManually**: В режиме автоматического управления целевая температура была изменена кнопками (1/0)

 * **LoopMode**: Текущий способ выбора первого или второго расписания в автоматическом режиме: 0: 5+2 дня, 1: 6+1 день, 2: 7 дней (см. документацию к термостату)
   * **SetLoopMode**: Установка способа выбора расписания, 0, 1 или 2 

 * **Schedule**, **Schedule2**: Первое и второе расписания в режиме автоматической работы. Указывает 
   с какого времени требуется установить заданную температуру. В первом расписании определяется 5 временных интервалов,
   во втором расписании только 2 (см. документацию к термостату)
   * **SetSchedule**, **SetSchedule2**: Установка расписаний работы. Формат соответствует значению топиков **Schedule** и **Schedule2**

 * **Hysteresis**: Точность, с которой будет выдерживаться заданная температура
 * **AdjTemp**: Поправка к значению датчика температуры RoomTemp/FloorTemp уже учитывают эту поправку.
   * **SetAdjTemp**: Задание поправки значения датчика температуры
 * **AutoAdjMode**: Режим автоматического управления коррекцией датчика температуры **AdjTemp**. Доступен только при использовании дополнительного 
   встроенного цифрового датчика температуры и влажности и управляет температурой воздуха (**Sensor**=0).\
    Доступные режимы:\
    0: AdjTemp задается только вручную либо топиком **SetAdjTemp** в настройках термостата;\
    1: RoomTemp подгоняется под температуру цифрового датчика (топик **Sensor/Temperature**)\
    2: RoomTemp подгоняется под субъективно ощущаемую температуру ("индекс тепла", топик **Sensor/HeatIndex**)
   * **SetAutoAdjMode**: Установка режима автоматического управления коррекцией датчика температуры.
 * **AntiFroze**: Режим защиты от замерзания включен (1) либо выключен (0)
   * **SetAntiFroze**: Управление режимом защиты от замерзания (0/1)
 * **PowerOnMemory**: Восстанавливать (1) или не восстанавливать (0) состояние термостата после пропадения питания
 * **Time**, **Weekday**: Время (ЧЧ:ММ) и текущий день недели (1..7)
   * **SetTime**, **SetWeekday**: Задание текущего веремени и дня недели. Допустимый формат времени "ЧЧ:ММ" или "ЧЧ:ММ:СС". В случае если в Config.h определена константа 
     TIMEZONE - время будет автоматически синхронизироваться по первому доступному NTP серверу в следующем порядке: "адрес MQTT брокера", "time.google.com" и "time.nist.gov".

### Заливка прошивки в модуль

    Для обновления прошивки модуля необходим USB/UART конвертер.

    К сожалению, штатная прошивка Tuya не предусматривает возможности обновления модуля "по воздуху" а 
работающий MCU мотора постоянно обменивается данными с модулем, вызывая ошибки.

    Поэтому перед обновлением необходимо разорвать цепь питания между модулем 
и основной платой контроллера. Сделать это можно выпаяв соответствующий пин либо перерезав дорожку на самом модуле


### Фотографии

[Несколько фотографий можно найти здесь](https://github.com/mosave/Beok2MQTT/tree/main/Photos)

