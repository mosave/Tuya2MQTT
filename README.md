# MQTT Firmware for Tuya WiFi Curtain Motor
### MQTT прошивка для привода раздвижных штор Tuya WiFi

Приводы раздвижных штор Tuya давно и заслуженно пользуются популярностью, являясь более дешевой альтернативой 
того же Somfy и предоставляя возможность интеграции в системы умного дома.

К сожалению, взаимодействие с WiFi версией моторов, как и с большинством WiFi IoT устройств, 
происходит через внешние сервера. А это (опуская прогон про "Большого Китайского Друга") делает 
управление зависимым как минимум от наличия и стабильности подключения в интернет.

Поэтому целью данного проекта была разработка альтернативной прошивки WiFi контроллера привода 
для прямого управления по протоколу MQTT.

Отмечу что это не первый подобный проект. Вы можете (и более того, я даже рекомендую ;) ) воспользоваться, например,

  * [Прошивкой Tasmota](https://github.com/Greefon/docs/blob/master/Tuya-generic-wifi-curtain-motor-WIP.md) либо
  * [Прошивкой на базе ESPHome](https://github.com/iphong/esphome-tuya-curtain)

К сожалению, как выяснилось позже, часть присланных мне приводов имеет не совпадающие с использованными
в Tasmota/ESPHome кодами команд управления, поэтому мне все равно пришлось разбираться в протоколе самому. 
Это было первой причиной появления проекта.

Второй причиной стало нежелание разводить зоопарк, поскольку все WiFi IoT устройства
у меня построены на базе [ESP8266 IoT Framework](https://github.com/mosave/AELib).

### Архитектура контроллера привода штор

Подобно большинству WiFi IoT устройств Tuya, контроллер мотора содержит два основных модуля:
  * Непосредственно железом (двигатель, энкодеры, защита от перегрузки, калибровка крайних положений, 
    ручное открытие/закрытие штор) управляет MCU. Он же принимает команды от опционального RF433 пульта,
    или проводного пульта (подключается через соответствующий разъем на корпусе)
  * Возможность внешнего управления шторами реализует модуль [Tuya TYWE3S](https://tasmota.github.io/docs/devices/TYWE3S/), 
    который по факту является обычным ESP8266 модулем с объемом флеш памяти 2мб. Модуль взаимодействует
    с MCU через последовательный интерфейс (9600/8/1/none) по стандартизованному Tuya протоколу. При этом 
    сам модуль не реализует логики по управлению устройством а является прозрачным шлюзом, через 
    который с MCU взаимодействует сервер Tuya и/или непосредственно мобильное приложение.
    Описание протокола можно найти в папке Docs и на [сайте Tasmota](https://tasmota.github.io/docs/TuyaMCU/)
      
Благодаря такой архитектуре устройство продолжает выполнять основные функции даже при полном отказе 
WiFi модуля. Поэтому можно без особых сложностей заменить стандартную прошивку WiFi модуля на альтернативную, 
реализующую иной способ взаимодействия с устройством. Например через прямые http запросы либо по MQTT протоколу
через установленный локально MQTT брокер.

### Список MQTT топиков для получения состояния и управления шторами

Как уже было отмечено, прошивка модуля собрана с использованием готового фреймворка, поэтому 
помимо описанного ниже поддерживает все
["стандартные" топики](https://github.com/mosave/AELib#comms-wifi-mqtt-%D0%B8-ota): 
конфигурация и текущее состояние устройства, перезагрузка, прошивка "по воздуху" и тд.

 * **State**: Текущее состояние привода. Payload - строка, одно из следующих значений:
   * **Idle**: шторы не двигаются
   * **Opening**, **Closing** или **Moving** (если направление движения установить невозможно)
   * **Failed**: не обращайте внимания, вы все равно никогда этого не увидите :)
 * **Position**: Текущее положение штор привода в процентах, payload - целое число в диапазоне 0..100. 
   После включения питания принимает значение 50 и остается таковым до проведения калибровки,
   то есть полного (до отсечки) открытия и закрытия штор.
 * **SetPosition**: Задать новое положение штор. Доступно только после калибровки. В качестве payload 
   передается процент открытия штор, целое число в диапазоне 0..100
 * **Command**: Команды управления шторами. В payload передается строка с названием команды:
   * **Open**: Открыть шторы (==SetPosition 100)
   * **Close**: Закрыть шторы (==SetPosition 0)
   * **Stop**: Остановить движение штор
   * **Continue**: Продолжить движение штор, прерванное командой Stop
   * **OpenKey**, **CloseKey**: "Двухкнопочная" логика управления шторами: команда запускает либо останавливает движение 
   шторы в заданном направлении
   * **SingleKey**: "Однокнопочная" логика управления шторами: начать/остановить движение шторы в текущем направлении.
   При достижении крайнего положения движение останавливается, а "текущее" направление меняется на противоположное.
   * **SetReversed**, **SetNormal**: изменить направление открытия/закрытия штор на противоположное. Реакция на эти команды 
   зависит от версии привода, которые могут изменять направление на противоположное в ответ на любую из этих команд.

* **Log**: Журнал обмена сообщений между WiFi модулем и MCU. Используется только для отладки и доступен 
  только если в файле конфигурации **config.h** определен символ **#define MCU_DEBUG**.
* **MCUCommand**: Отправить команду MCU. Аналогично предыдущему топику, доступен только при включении режима отладки.
  В качестве payload передается последовательность байт в виде шестнадцатеричной строки БЕЗ контрольной суммы. 
  Например отправка строки ```55aa000600056504000102``` приведет к полному открытию штор (если MCU поддерживает данную команду).

### Сценарии управления шторами при помощи клавишных выключателей

Я не буду рассматривать вполне очевидные способы интеграции штор в системы УД. State, Position, SetPosition и команды 
Open/Close/Stop реализуют достаточный набор функций для этого. Ниже приведены несколько сценариев привязки штор к 
настенным клавишным выключателям.
  * Выделенный двухклавишный выключатель без фиксации: к нажатию (короткому или длинному) клавиш привязать команды 
  "OpenKey" и "CloseKey". Повторное нажатие клавиш будет приводить к остановке движения в промежуточной точке.
  * Двухклавишный выключатель с фиксацией: к включению привязываем команды "OpenKey" и "CloseKey", к выключению - "Stop"
  * Одна клавиша без фиксации: привязка команды "SingleKey" позволит открывать и закрывать шторы с возможностью 
  остановки в любом промежуточном положении.
  * Одна клавиша: на событие "нажатие и удержание" привязать команду "Continue", на "отпускание удерживаемой клавиши" - "Stop"



### Настройка прошивки

В каталоге [Firmware](https://github.com/mosave/Tuya2MQTT/tree/main/Firmware) находятся исходники прошивки. 
Для ее заливки я рекомендую использовать Arduino IDE либо любую другую среду разработки для Arduino: Visual Studio Code,
Visual Studio с пакетом Visual Micro, PlatformIO или аналогичные.

Перед началом процесса прошивки необходимо просмотреть и внести изменения в файл **config.h**.
Например, нужно задать параметры подключения к WiFi и адрес MQTT брокера (если в сети не настроено 
анонсирование брокера через сервис MDNS).

Не определяйте символ USE_SOFT_SERIAL, этот режим используется при разработке прошивки и приводит к тому что 
команды MCU отправляются не на стандартный последовательный интерфейс а на SoftSerial.

### Заливка прошивки в модуль

Для извлечения платы контроллера из двигателя достаточно открутить четыре самореза с нижнего торца 
двигателя и два удерживающих плату на пластиковой заглушке и 12в блоке питания:

![Расположение элементов на плате контроллера](https://github.com/mosave/Tuya2MQTT/raw/main/Photos/01Layout.jpg)

К сожалению, штатная прошивка TYWE3S не предусматривает возможности обновления модуля "по воздуху" а 
MCU к тому же постоянно шлет пакеты, вызывая ошибки при попытке прошить его без отключения от основной платы контроллера.
Поэтому перед обновлением необходимо разорвать цепь питания между WiFi модулем и основной платой. 
Сделать это можно выпаяв (перекусив?) соответствующий пин либо перерезав дорожку на самом модуле.

Я просто выпаивал пин со стороны основной платы мощным паяльником (там большая контактная площадка, которую 
трудно прогреть) а после прошивки восстанавливал шину питания "соплей". Это дает возможность в будущем, если вдруг 
снова понадобится прошивка по проводам, сделать это без танецв с бубном.

![Шина питания WiFi модуля](https://github.com/mosave/Tuya2MQTT/raw/main/Photos/02ControlBoard.jpg)

После разрыва цепи питания между модулем и контроллером к последовательному интерфейсу необходимо
подключить USB/UART адаптер а выход PIO-0 модуля временно (желательно через кнопку) замкнуть на землю.
А для этого понадобится собственно USB/UART адаптер. Купить его на aliexpress можно по цене семечек, но лично 
мне нравится чуть дороже, [вот такой](https://aliexpress.ru/item/4000409620491.html) 
(внимание, по ссылке 5шт!). 

![Подключение uart программатора к WiFi модулю](https://github.com/mosave/Tuya2MQTT/raw/main/Photos/03Wiring.jpg)

Проверяем (дважды!) что на адаптере правильно установлено напряжение питания 3.3v, замыкаем PIO0 на GND кнопкой 
(если она есть), подключаем адаптер к компьютеру, в ArduinoIDE выбираем появившийся COM порт и:
  * выставляем скорость в 115200 
  * Board: "ESP8266 generic (Chip is ESP8266EX)"
  * Flash size: 2MB / FS:None
  * На всякий случай "Erase Flash: ALL content"
  * Жмем "Build and Upload"
  * Дожидаемся завершения прошивки, отключаем программатор
  * Восстанавливаем питание, убеждаемся в работоспособности модуля
  * Собираем привод штор, пользуемся.

Я предполагаю, что дочитавший до этого места имеет представление о прошивке ESP8266, знает что RX/TX модуля
подключается к TX/RX адаптера (вперехлест), что кнопку Flash не стоит отпускать до окончания процесса прошивки
и - умеет сам решать возникающие трудности. Я не готов устраивать ликбез, со всеми вопросами сразу идите в гугль :)

### Бонусы и плюшки

ESP8266 - интересная и достаточно мощная штука, которая помимо управления шторами решать и кучу других задач. 
Например, к нему можно подключить датчики температуры и влажности (хотя расположение у окна 
за шторами не лучшее), датчики открытия окна, движения или просто освещенности на улице. 
Для этих целей я дополнительно вывожу 3.3v, GPIO4 и GPIO5 на разъем на корпусе привода:

![Вывод I2C на внешний разъем](https://github.com/mosave/Tuya2MQTT/raw/main/Photos/04_I2C.jpg)
![I2C разъем на приводе](https://github.com/mosave/Tuya2MQTT/raw/main/Photos/05_I2C.jpg)

